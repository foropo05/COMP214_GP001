 

-- DROP TABLES (order matters) 

 

DROP TABLE booking_item CASCADE CONSTRAINTS; 

DROP TABLE booking CASCADE CONSTRAINTS; 

DROP TABLE payment CASCADE CONSTRAINTS; 

DROP TABLE passenger CASCADE CONSTRAINTS; 

DROP TABLE flight CASCADE CONSTRAINTS; 

DROP TABLE fare_class CASCADE CONSTRAINTS; 

DROP TABLE airport CASCADE CONSTRAINTS; 

DROP TABLE aircraft CASCADE CONSTRAINTS; 

DROP TABLE staff CASCADE CONSTRAINTS; 

DROP TABLE audit_log CASCADE CONSTRAINTS; 

 

 

-- 1. AIRPORT 

 

CREATE TABLE airport (  

  airport_code CHAR(3) PRIMARY KEY, 

  name         VARCHAR2(80) NOT NULL, 

  city         VARCHAR2(60) NOT NULL, 

  country      VARCHAR2(60) NOT NULL 

); 

 

-- 2. FARE CLASS (LOOKUP) 

CREATE TABLE fare_class ( 

  fare_code   VARCHAR2(2) PRIMARY KEY,     -- Y, W, J, F 

  name        VARCHAR2(30) NOT NULL, 

  base_mult   NUMBER(6,3)  NOT NULL CHECK (base_mult > 0) 

); 

 

 

-- 3. AIRCRAFT 

CREATE TABLE aircraft ( 

  aircraft_id  NUMBER PRIMARY KEY, 

  model        VARCHAR2(40) NOT NULL,      

  manufacturer VARCHAR2(40) NOT NULL, 

  capacity     NUMBER(4)    NOT NULL CHECK (capacity > 0) 

); 

 

 

-- 4. FLIGHT 

CREATE TABLE flight ( 

  flight_id              NUMBER PRIMARY KEY, 

  flight_number          VARCHAR2(8) NOT NULL UNIQUE,       

  departure_airport_code CHAR(3)    NOT NULL REFERENCES airport(airport_code), 

  arrival_airport_code   CHAR(3)    NOT NULL REFERENCES airport(airport_code), 

  aircraft_id            NUMBER     NOT NULL REFERENCES aircraft(aircraft_id), 

  departure_time         DATE       NOT NULL, 

  arrival_time           DATE       NOT NULL, 

  base_price             NUMBER(8,2) NOT NULL CHECK (base_price >= 0), 

  capacity               NUMBER(4)   NOT NULL CHECK (capacity > 0), 

  seats_sold             NUMBER(4)   DEFAULT 0 CHECK (seats_sold >= 0) 

); 

 

ALTER TABLE flight ADD CONSTRAINT chk_flight_times 

  CHECK (arrival_time > departure_time); 

 

-- 5. PASSENGER (WITH ACCESSIBILITY SUPPORT) 

 

CREATE TABLE passenger ( 

  passenger_id        NUMBER PRIMARY KEY, 

  full_name           VARCHAR2(100) NOT NULL, 

  email               VARCHAR2(120) NOT NULL UNIQUE, 

  phone               VARCHAR2(30), 

  passport_no         VARCHAR2(20), 

  needs_assistance    CHAR(3) DEFAULT 'NO',     -- 'Y' or 'N' 

  assistance_details  VARCHAR2(200)            -- e.g. 'Wheelchair', 'Blind passenger' 

); 

 

-- 6. BOOKING 

CREATE TABLE booking ( 

  booking_id        NUMBER PRIMARY KEY, 

  passenger_id      NUMBER NOT NULL REFERENCES passenger(passenger_id), 

  booked_at         DATE   DEFAULT SYSDATE, 

  confirmation_code VARCHAR2(12) NOT NULL UNIQUE, 

  total_amount      NUMBER(10,2) DEFAULT 0 CHECK (total_amount >= 0), 

  status            VARCHAR2(12) DEFAULT 'PENDING' 

); 

 

-- 7. BOOKING ITEM 

CREATE TABLE booking_item ( 

  booking_item_id NUMBER PRIMARY KEY, 

  booking_id      NUMBER NOT NULL REFERENCES booking(booking_id) ON DELETE CASCADE, 

  flight_id       NUMBER NOT NULL REFERENCES flight(flight_id), 

  fare_code       VARCHAR2(2) NOT NULL REFERENCES fare_class(fare_code), 

  seat_no         VARCHAR2(5), 

  price_paid      NUMBER(8,2) NOT NULL CHECK (price_paid >= 0) 

); 

 

-- 8. PAYMENT 

 

CREATE TABLE payment ( 

  payment_id    NUMBER PRIMARY KEY, 

  booking_id    NUMBER NOT NULL REFERENCES booking(booking_id) ON DELETE CASCADE, 

  paid_at       DATE   DEFAULT SYSDATE, 

  amount        NUMBER(10,2) NOT NULL CHECK (amount >= 0), 

  method        VARCHAR2(20) NOT NULL,  

  status        VARCHAR2(12) DEFAULT 'SUCCESS'  

); 

 

-- 9. STAFF (CLEAN VERSION) 

 

CREATE TABLE staff ( 

  staff_id   NUMBER PRIMARY KEY, 

  full_name  VARCHAR2(100) NOT NULL, 

  role       VARCHAR2(30)  NOT NULL,     -- Admin, Agent, Pilot, Crew 

  email      VARCHAR2(120) NOT NULL UNIQUE, 

  salary     NUMBER(10,2) 

); 

 

ALTER TABLE flight ADD pilot_id NUMBER; 

 

ALTER TABLE flight  

  ADD CONSTRAINT fk_flight_pilot  

  FOREIGN KEY (pilot_id) REFERENCES staff(staff_id); 

 

-- 10. AUDIT LOG 

CREATE TABLE audit_log ( 

  audit_id   NUMBER PRIMARY KEY, 

  table_name VARCHAR2(30) NOT NULL, 

  pk_value   VARCHAR2(100) NOT NULL, 

  action     VARCHAR2(10) NOT NULL, 

  changed_at DATE DEFAULT SYSDATE, 

  changed_by VARCHAR2(60) DEFAULT USER, 

  details    VARCHAR2(4000) 

); 

 

-- THE SEQUENCE PART 

-- 11. SEQUENCES (FOR PRIMARY KEYS + AUDIT) 

 

-- For AIRCRAFT.aircraft_id 

CREATE SEQUENCE seq_aircraft 

  START WITH 100 

  INCREMENT BY 1 

  NOCACHE; 

 

-- For FLIGHT.flight_id 

CREATE SEQUENCE seq_flight 

  START WITH 1000 

  INCREMENT BY 1 

  NOCACHE; 

 

-- For PASSENGER.passenger_id 

CREATE SEQUENCE seq_passenger 

  START WITH 5000 

  INCREMENT BY 1 

  NOCACHE; 

 

-- For BOOKING.booking_id 

CREATE SEQUENCE seq_booking 

  START WITH 9000 

  INCREMENT BY 1 

  NOCACHE; 

 

-- For BOOKING_ITEM.booking_item_id 

CREATE SEQUENCE seq_booking_item 

  START WITH 20000 

  INCREMENT BY 1 

  NOCACHE; 

 

-- For PAYMENT.payment_id 

CREATE SEQUENCE seq_payment 

  START WITH 30000 

  INCREMENT BY 1 

  NOCACHE; 

 

-- For STAFF.staff_id 

CREATE SEQUENCE seq_staff 

  START WITH 600 

  INCREMENT BY 1 

  NOCACHE; 

 

-- For AUDIT_LOG.audit_id 

CREATE SEQUENCE seq_audit 

  START WITH 1 

  INCREMENT BY 1 

  NOCACHE; 

 

-- 12. BEFORE INSERT TRIGGERS (USE SEQUENCES FOR PKs) 

 

-- AIRCRAFT.aircraft_id 

CREATE OR REPLACE TRIGGER trg_aircraft_bi 

BEFORE INSERT ON aircraft 

FOR EACH ROW 

BEGIN 

  IF :NEW.aircraft_id IS NULL THEN 

    :NEW.aircraft_id := seq_aircraft.NEXTVAL; 

  END IF; 

END; 

/ 

 

-- FLIGHT.flight_id 

CREATE OR REPLACE TRIGGER trg_flight_bi 

BEFORE INSERT ON flight 

FOR EACH ROW 

BEGIN 

  IF :NEW.flight_id IS NULL THEN 

    :NEW.flight_id := seq_flight.NEXTVAL; 

  END IF; 

END; 

/ 

 

-- PASSENGER.passenger_id 

CREATE OR REPLACE TRIGGER trg_passenger_bi 

BEFORE INSERT ON passenger 

FOR EACH ROW 

BEGIN 

  IF :NEW.passenger_id IS NULL THEN 

    :NEW.passenger_id := seq_passenger.NEXTVAL; 

  END IF; 

END; 

/ 

 

-- BOOKING.booking_id 

CREATE OR REPLACE TRIGGER trg_booking_bi 

BEFORE INSERT ON booking 

FOR EACH ROW 

BEGIN 

  IF :NEW.booking_id IS NULL THEN 

    :NEW.booking_id := seq_booking.NEXTVAL; 

  END IF; 

END; 

/ 

 

-- BOOKING_ITEM.booking_item_id 

CREATE OR REPLACE TRIGGER trg_booking_item_bi 

BEFORE INSERT ON booking_item 

FOR EACH ROW 

BEGIN 

  IF :NEW.booking_item_id IS NULL THEN 

    :NEW.booking_item_id := seq_booking_item.NEXTVAL; 

  END IF; 

END; 

/ 

 

-- PAYMENT.payment_id 

CREATE OR REPLACE TRIGGER trg_payment_bi 

BEFORE INSERT ON payment 

FOR EACH ROW 

BEGIN 

  IF :NEW.payment_id IS NULL THEN 

    :NEW.payment_id := seq_payment.NEXTVAL; 

  END IF; 

END; 

/ 

 

-- STAFF.staff_id 

CREATE OR REPLACE TRIGGER trg_staff_bi 

BEFORE INSERT ON staff 

FOR EACH ROW 

BEGIN 

  IF :NEW.staff_id IS NULL THEN 

    :NEW.staff_id := seq_staff.NEXTVAL; 

  END IF; 

END; 

/ 

 

-- AUDIT_LOG.audit_id 

CREATE OR REPLACE TRIGGER trg_audit_bi 

BEFORE INSERT ON audit_log 

FOR EACH ROW 

BEGIN 

  IF :NEW.audit_id IS NULL THEN 

    :NEW.audit_id := seq_audit.NEXTVAL; 

  END IF; 

END; 

/ 

--Searching for flights 

CREATE INDEX idx_flight_route_date 

ON flight (departure_airport_code, arrival_airport_code, departure_time); 

-- (Passenger email already indexed by UNIQUE constraint) 

-- (Booking confirmation_code already indexed by UNIQUE constraint) 

 

-- 14. AUDIT TRIGGERS (log changes into AUDIT_LOG) 

 

-- 1) Log updates to FLIGHT (price, seats, etc.) 

CREATE OR REPLACE TRIGGER trg_flight_au 

AFTER UPDATE ON flight 

FOR EACH ROW 

BEGIN 

  INSERT INTO audit_log ( 

    audit_id, 

    table_name, 

    pk_value, 

    action, 

    details 

  ) VALUES ( 

    seq_audit.NEXTVAL,                 -- sequence used on UPDATE 

    'FLIGHT', 

    TO_CHAR(:NEW.flight_id), 

    'UPDATE', 

    'seats_sold: ' || :OLD.seats_sold || ' -> ' || :NEW.seats_sold || 

    ', base_price: ' || :OLD.base_price || ' -> ' || :NEW.base_price 

  ); 

END; 

/ 

 

-- 2) Log updates to BOOKING (total, status) 

CREATE OR REPLACE TRIGGER trg_booking_au 

AFTER UPDATE ON booking 

FOR EACH ROW 

BEGIN 

  INSERT INTO audit_log ( 

    audit_id, 

    table_name, 

    pk_value, 

    action, 

    details 

  ) VALUES ( 

    seq_audit.NEXTVAL, 

    'BOOKING', 

    TO_CHAR(:NEW.booking_id), 

    'UPDATE', 

    'total_amount: ' || :OLD.total_amount || ' -> ' || :NEW.total_amount || 

    ', status: ' || :OLD.status || ' -> ' || :NEW.status 

  ); 

END; 

/ 

 

-- 3) Log new PAYMENTS 

CREATE OR REPLACE TRIGGER trg_payment_ai 

AFTER INSERT ON payment 

FOR EACH ROW 

BEGIN 

  INSERT INTO audit_log ( 

    audit_id, 

    table_name, 

    pk_value, 

    action, 

    details 

  ) VALUES ( 

    seq_audit.NEXTVAL, 

    'PAYMENT', 

    TO_CHAR(:NEW.payment_id), 

    'INSERT', 

    'booking_id=' || :NEW.booking_id || 

    ', amount='   || :NEW.amount || 

    ', method='   || :NEW.method || 

    ', status='   || :NEW.status 

  ); 

END; 

/ 

 